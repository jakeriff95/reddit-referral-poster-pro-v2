<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reddit Referral Poster</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { padding: 20px; }
    .log-table { font-size: 0.85rem; }
    .running-badge { font-weight: bold; }
  </style>
</head>
<body>

<div class="container">
  <h2 class="mb-4">Reddit Referral Poster</h2>

  {% if not logged_in %}
    <div class="alert alert-warning">
      <strong>Not logged in.</strong> Please <a href="{{ url_for('oauth_login') }}">log in with Reddit</a>.
    </div>
  {% else %}
    <p>Logged in as <strong>{{ user }}</strong></p>
  {% endif %}

  <form id="startForm" class="mb-4">
    <div class="row mb-2">
      <div class="col-md-3">
        <label for="preset" class="form-label">Preset</label>
        <select id="preset" name="preset" class="form-select">
          <option value="">Custom</option>
          {% for p in presets %}
            <option value="{{ p }}">{{ p|capitalize }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label for="brand" class="form-label">Brand</label>
        <input type="text" id="brand" name="brand" class="form-control" placeholder="GoPuff">
      </div>
      <div class="col-md-3">
        <label for="ref_code" class="form-label">Referral Code</label>
        <input type="text" id="ref_code" name="ref_code" class="form-control" placeholder="ABC123">
      </div>
      <div class="col-md-3">
        <label for="discount" class="form-label">Discount (%)</label>
        <input type="number" id="discount" name="discount" class="form-control" placeholder="20">
      </div>
    </div>

    <div class="row mb-2">
      <div class="col-md-4">
        <label for="ref_link" class="form-label">Referral Link</label>
        <input type="url" id="ref_link" name="ref_link" class="form-control" placeholder="https://...">
      </div>
      <div class="col-md-4">
        <label for="message" class="form-label">Base Message (optional)</label>
        <textarea id="message" name="message" class="form-control" rows="2" placeholder="Leave blank to auto-generate"></textarea>
      </div>
      <div class="col-md-4">
        <label for="region" class="form-label">Region</label>
        <select id="region" name="region" class="form-select">
          <option value="US" selected>United States</option>
          <option value="ALL">No restriction</option>
        </select>
      </div>
    </div>

    <div class="row mb-2">
      <div class="col-md-2">
        <label for="days_back" class="form-label">Days Back</label>
        <input type="number" id="days_back" name="days_back" value="60" class="form-control">
      </div>
      <div class="col-md-2">
        <label for="per_sub_limit" class="form-label">Per Sub Limit</label>
        <input type="number" id="per_sub_limit" name="per_sub_limit" value="1" class="form-control">
      </div>
      <div class="col-md-2">
        <label for="max_total_posts" class="form-label">Max Total Posts</label>
        <input type="number" id="max_total_posts" name="max_total_posts" value="10" class="form-control">
      </div>
      <div class="col-md-2">
        <label for="posts_per_hour" class="form-label">Posts per Hour</label>
        <input type="number" id="posts_per_hour" name="posts_per_hour" value="1" class="form-control">
      </div>
      <div class="col-md-2">
        <label for="jitter_seconds" class="form-label">Jitter (sec)</label>
        <input type="number" id="jitter_seconds" name="jitter_seconds" value="30" class="form-control">
      </div>
      <div class="col-md-2">
        <label for="duration_minutes" class="form-label">Run Duration (min)</label>
        <input type="number" id="duration_minutes" name="duration_minutes" value="60" class="form-control">
      </div>
    </div>

    <div class="row mb-2">
      <div class="col-md-3">
        <label for="tone" class="form-label">Tone</label>
        <select id="tone" name="tone" class="form-select">
          <option value="friendly" selected>Friendly</option>
          <option value="concise">Concise</option>
          <option value="detailed">Detailed</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="emoji_level" class="form-label">Emoji Level</label>
        <select id="emoji_level" name="emoji_level" class="form-select">
          <option value="low">Low</option>
          <option value="normal" selected>Normal</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Disclaimer</label>
        <select id="add_disclaimer" name="add_disclaimer" class="form-select">
          <option value="true" selected>Yes</option>
          <option value="false">No</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="dry_run" class="form-label">Dry Run</label>
        <select id="dry_run" name="dry_run" class="form-select">
          <option value="true" selected>Yes</option>
          <option value="false">No (Live)</option>
        </select>
      </div>
    </div>

    <div class="mb-3">
      <button type="submit" class="btn btn-success" id="startBtn">Start</button>
      <button type="button" class="btn btn-danger" id="stopBtn" disabled>Stop</button>
    </div>
  </form>

  <h4>Status: <span id="status" class="running-badge">Idle</span></h4>

  <div id="summaryContainer" style="display:none;">
    <h5>Summary</h5>
    <table class="table table-sm table-bordered" id="summaryTable">
      <thead>
        <tr><th>Subreddit</th><th>Posts</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <h5>Logs</h5>
  <table class="table table-sm table-striped log-table" id="logTable">
    <thead>
      <tr><th>Time</th><th>Level</th><th>Event</th><th>Details</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
function pollStatus() {
  $.getJSON('/status', function(data) {
    $('#status').text(data.running ? 'Running' : 'Idle')
                .toggleClass('text-success', data.running)
                .toggleClass('text-danger', !data.running);
    $('#startBtn').prop('disabled', data.running);
    $('#stopBtn').prop('disabled', !data.running);

    const tbody = $('#logTable tbody');
    tbody.empty();
    (data.logs || []).slice(-50).reverse().forEach(log => {
      const tr = $('<tr>');
      tr.append($('<td>').text(log.ts));
      tr.append($('<td>').text(log.level));
      tr.append($('<td>').text(log.event));
      tr.append($('<td>').text(JSON.stringify(log)));
      tbody.append(tr);
    });

    if (data.summary && Object.keys(data.summary).length > 0) {
      $('#summaryContainer').show();
      const sbody = $('#summaryTable tbody').empty();
      Object.entries(data.summary).forEach(([sub, count]) => {
        sbody.append($('<tr>').append($('<td>').text(sub), $('<td>').text(count)));
      });
    }
  });
}

$('#startForm').submit(function(e) {
  e.preventDefault();
  $.post('/start', $(this).serialize(), function(resp) {
    pollStatus();
  });
});

$('#stopBtn').click(function() {
  $.post('/stop', function() {
    pollStatus();
  });
});

setInterval(pollStatus, 3000);
pollStatus();
</script>

</body>
</html>
